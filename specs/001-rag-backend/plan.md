# Implementation Plan: Physical AI RAG Backend

**Branch**: `001-rag-backend` | **Date**: 2025-12-24 | **Spec**: specs/001-rag-backend/spec.md
**Input**: Feature specification from `/specs/001-rag-backend/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build a pure RAG backend using FastAPI and Google Gemini 2.0 Flash to power the Physical AI Textbook chatbot. The system will implement vector search against textbook content using Qdrant, with answers generated by Gemini 2.0 Flash model through OpenAI SDK. The backend will provide three main endpoints: standard question answering, contextual explanations for selected text, and health checks.

## Technical Context

**Language/Version**: Python 3.11
**Primary Dependencies**: fastapi, uvicorn, openai, qdrant-client, python-dotenv
**Storage**: Qdrant Cloud (vector database), Neon Postgres (metadata)
**Testing**: pytest
**Target Platform**: Linux server (Docker container)
**Project Type**: Web application (backend API service)
**Performance Goals**: <1.5 seconds per query, 95% of requests under 1.5 seconds
**Constraints**: <200 tokens max answer length, source-bound accuracy, no hallucinations, must use textbook content only
**Scale/Scope**: Single textbook corpus, individual student usage, API-based integration with frontend

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

1. **Source-bound accuracy**: Implementation must ensure all answers are grounded in textbook content only, with proper retrieval from vector store
2. **Transparency of reasoning**: System must provide clear citations with Qdrant vector reference keys in responses
3. **Reliability**: No hallucinations - implementation must include checks to prevent fabricated information
4. **Spec-Driven Development**: All implementation must follow the defined functional requirements from spec
5. **Performance Excellence**: Must achieve <1.5 second response times as specified in constitution
6. **Retrieval Discipline**: Must implement proper logic for selected text vs general question handling
7. **Data Governance**: All chunks must map to Neon Postgres metadata rows with correct chunk_id references

## Project Structure

### Documentation (this feature)

```text
specs/001-rag-backend/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI app initialization
│   ├── config/
│   │   ├── __init__.py
│   │   ├── settings.py      # Environment configuration
│   │   └── cors.py          # CORS configuration
│   ├── models/
│   │   ├── __init__.py
│   │   ├── request.py       # API request models
│   │   └── response.py      # API response models
│   ├── services/
│   │   ├── __init__.py
│   │   ├── gemini_client.py # Gemini API client
│   │   ├── qdrant_client.py # Vector store client
│   │   ├── rag_engine.py    # Core RAG logic
│   │   └── embedding.py     # Query embedding logic
│   ├── api/
│   │   ├── __init__.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── router.py    # Main API router
│   │   │   ├── ask.py       # /api/ask endpoint
│   │   │   ├── ask_selection.py # /api/ask-selection endpoint
│   │   │   └── health.py    # /api/health endpoint
│   └── utils/
│       ├── __init__.py
│       └── validation.py    # Input validation utilities
├── tests/
│   ├── __init__.py
│   ├── unit/
│   ├── integration/
│   └── contract/
├── .env.example
├── .gitignore
├── requirements.txt
├── Dockerfile
├── docker-compose.yml
└── README.md
```

**Structure Decision**: Selected web application backend structure with modular organization by functionality (models, services, API endpoints). This structure supports the three required endpoints and separates concerns for maintainability.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |
